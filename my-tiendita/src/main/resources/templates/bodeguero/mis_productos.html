<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{bodeguero/layout :: layout(
        title=${title},
        content=~{::content},
        styles=~{::styles},
        scripts=~{::scripts},
        modals=~{::modals}
      )}">

<head>
    <!-- ======= ESTILOS ======= -->
    <th:block th:fragment="styles">
      <link rel="stylesheet" th:href="@{/css/bodeguero/styles.css}" />
    </th:block>
</head>

<!-- ======= CONTENIDO PRINCIPAL ======= -->
<th:block th:fragment="content">

  <!-- Error si no tiene bodegas -->
  <div th:if="${error}" class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span th:text="${error}"></span>
  </div>

  <!-- Selector de Bodega -->
  <div th:if="${mostrarSelector}" class="alert alert-info" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    <strong>Selecciona una bodega para gestionar sus productos:</strong>
    <div class="mt-3">
      <select class="form-select form-select-lg" id="selectorBodega" onchange="seleccionarBodega()">
        <option value="" selected disabled>-- Seleccionar bodega --</option>
        <option th:each="bodega : ${bodegas}" 
                th:value="${bodega.id}" 
                th:text="${bodega.nombre}">
        </option>
      </select>
    </div>
  </div>

  <!-- Contenido principal (solo si hay bodega seleccionada) -->
  <div th:if="${bodegaSeleccionada}" id="contenidoPrincipal">

    <!-- HEADER: acciones -->
    <div class="productos-header">
      <div class="header-left">
        <h2 class="page-title mb-0">
          <i class="bi bi-box-seam me-2"></i> Mis Productos
        </h2>
      </div>
      <div class="header-right">
        <button class="btn btn-primary btn-add" onclick="abrirModalCatalogo()">
          <i class="bi bi-plus-circle me-2"></i> Agregar del Catálogo
        </button>
      </div>
    </div>

    <div id="alertPlaceholder" class="mt-3"></div>

    <!-- Filtros y búsqueda -->
    <div class="filtros-container">
      <div class="row g-3 align-items-end">
        
        <!-- Buscador -->
        <div class="col-lg-4 col-md-6">
          <label class="form-label fw-semibold">
            <i class="bi bi-search me-1"></i>
            Buscar producto
          </label>
          <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   id="inputBuscar" 
                   placeholder="Nombre del producto..."
                   onkeyup="buscarProductos()">
            <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusqueda()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <!-- Filtro categoría -->
        <div class="col-lg-3 col-md-6">
          <label class="form-label fw-semibold">
            <i class="bi bi-tag me-1"></i>
            Categoría
          </label>
          <select class="form-select" id="filtroCategoriaId" onchange="aplicarFiltros()">
            <option value="">Todas</option>
          </select>
        </div>

        <!-- Filtro estado -->
        <div class="col-lg-2 col-md-6">
          <label class="form-label fw-semibold">
            <i class="bi bi-toggle-on me-1"></i>
            Estado
          </label>
          <select class="form-select" id="filtroEstado" onchange="aplicarFiltros()">
            <option value="">Todos</option>
            <option value="true">Activos</option>
            <option value="false">Inactivos</option>
          </select>
        </div>

        <!-- Filtro stock bajo -->
        <div class="col-lg-3 col-md-6">
          <div class="form-check form-switch pt-4">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="filtroStockBajo" 
                   onchange="aplicarFiltros()">
            <label class="form-check-label fw-semibold" for="filtroStockBajo">
              <i class="bi bi-exclamation-triangle text-warning me-1"></i>
              Solo stock bajo
            </label>
          </div>
        </div>

      </div>
    </div>

    <!-- Contador de productos -->
    <div class="productos-contador mb-3">
      <span class="text-muted">
        <i class="bi bi-box me-1"></i>
        <strong id="contadorProductos">0</strong> Productos en tu Bodega
      </span>
    </div>

    <!-- Grid de productos -->
    <div class="row g-3" id="productosGrid">
      <!-- Las cards se cargan dinámicamente con JavaScript -->
    </div>

    <!-- Mensaje si no hay productos -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <i class="bi bi-inbox"></i>
      <h4>No hay productos</h4>
      <p class="text-muted">Agrega productos del catálogo para comenzar a gestionar tu inventario</p>
      <button class="btn btn-primary" onclick="abrirModalCatalogo()">
        <i class="bi bi-plus-circle me-2"></i>
        Agregar Productos
      </button>
    </div>

  </div>

</th:block>

<!-- ==================== MODALES ==================== -->
<th:block th:fragment="modals">

<!-- Modal: Catálogo de productos -->
<div class="modal fade" id="modalCatalogo" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-grid-3x3-gap me-2"></i>
          Catálogo de Productos
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Buscador en catálogo -->
        <div class="mb-3">
          <input type="text" 
                 class="form-control" 
                 id="buscarCatalogo" 
                 placeholder="Buscar en el catálogo..."
                 onkeyup="filtrarCatalogo()">
        </div>

        <!-- Filtro categoría en catálogo -->
        <div class="mb-3">
          <select class="form-select" id="filtroCatalogoCategoriaId" onchange="filtrarCatalogo()">
            <option value="">Todas las categorías</option>
          </select>
        </div>

        <!-- Grid de productos del catálogo -->
        <div class="row g-3" id="catalogoGrid">
          <!-- Se carga dinámicamente -->
        </div>

        <!-- Loading -->
        <div class="text-center py-5" id="catalogoLoading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal: Agregar producto -->
<div class="modal fade" id="modalAgregar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i>
          Agregar Producto a Mi Bodega
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formAgregar" onsubmit="guardarProducto(event)">
        <div class="modal-body">
          
          <input type="hidden" id="agregarProductoId">

          <!-- Info del producto -->
          <div class="producto-info-card mb-3">
            <img id="agregarProductoImagen" src="" alt="" class="producto-preview-img">
            <div>
              <h6 class="mb-1" id="agregarProductoNombre"></h6>
              <small class="text-muted" id="agregarProductoCategoria"></small>
            </div>
          </div>

          <!-- Precio sugerido -->
          <div class="alert alert-info">
            <small><strong>Precio sugerido:</strong> S/ <span id="agregarPrecioSugerido"></span></small>
          </div>

          <!-- Precio bodeguero -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Precio de Venta <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">S/</span>
              <input type="number" 
                     class="form-control" 
                     id="agregarPrecioBodeguero" 
                     step="0.01" 
                     min="0.01" 
                     required>
            </div>
            <small class="text-muted">Define el precio al que venderás este producto</small>
          </div>

          <!-- Stock inicial -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Stock Inicial <span class="text-danger">*</span></label>
            <input type="number" 
                   class="form-control" 
                   id="agregarStock" 
                   min="0" 
                   value="0" 
                   required>
            <small class="text-muted">Cantidad disponible en tu bodega</small>
          </div>

          <!-- Estado -->
          <div class="form-check form-switch">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="agregarActivo" 
                   checked>
            <label class="form-check-label" for="agregarActivo">
              Producto activo (disponible para venta)
            </label>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>
            Agregar Producto
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Editar producto -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square me-2"></i>
          Editar Producto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formEditar" onsubmit="actualizarProducto(event)">
        <div class="modal-body">
          
          <input type="hidden" id="editarId">

          <!-- Info del producto -->
          <div class="producto-info-card mb-3">
            <img id="editarProductoImagen" src="" alt="" class="producto-preview-img">
            <div>
              <h6 class="mb-1" id="editarProductoNombre"></h6>
              <small class="text-muted" id="editarProductoCategoria"></small>
            </div>
          </div>

          <!-- Precio sugerido -->
          <div class="alert alert-info">
            <small><strong>Precio sugerido:</strong> S/ <span id="editarPrecioSugerido"></span></small>
          </div>

          <!-- Precio bodeguero -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Precio de Venta <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">S/</span>
              <input type="number" 
                     class="form-control" 
                     id="editarPrecioBodeguero" 
                     step="0.01" 
                     min="0.01" 
                     required>
            </div>
          </div>

          <!-- Stock -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Stock <span class="text-danger">*</span></label>
            <input type="number" 
                   class="form-control" 
                   id="editarStock" 
                   min="0" 
                   required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-2"></i>
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Ver detalle -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-eye me-2"></i>
          Detalle del Producto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <div class="row">
          <div class="col-md-4 text-center">
            <img id="detalleImagen" src="" alt="" class="img-fluid rounded mb-3">
          </div>
          <div class="col-md-8">
            <h4 id="detalleNombre" class="mb-3"></h4>
            
            <div class="mb-3">
              <span class="badge bg-primary" id="detalleCategoria"></span>
              <span class="badge bg-info" id="detalleSubcategoria"></span>
            </div>

            <p class="text-muted" id="detalleDescripcion"></p>

            <hr>

            <div class="row g-3">
              <div class="col-6">
                <label class="text-muted small">Precio Sugerido</label>
                <h5 class="text-primary">S/ <span id="detallePrecioSugerido"></span></h5>
              </div>
              <div class="col-6">
                <label class="text-muted small">Tu Precio</label>
                <h5 class="text-success">S/ <span id="detallePrecioBodeguero"></span></h5>
              </div>
              <div class="col-6">
                <label class="text-muted small">Stock Actual</label>
                <h5 id="detalleStock"></h5>
              </div>
              <div class="col-6">
                <label class="text-muted small">Estado</label>
                <h5 id="detalleActivo"></h5>
              </div>
            </div>

          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Confirmar desactivar/quitar -->
<div class="modal fade" id="modalConfirmar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Confirmar Acción
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="mensajeConfirmacion"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarAccion">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

</th:block>

<!-- ======= SCRIPTS ======= -->
<th:block th:fragment="scripts">
  <script th:inline="javascript">
    const BODEGA_ID = /*[[${bodegaId}]]*/ null;
  </script>
  <script th:src="@{/js/bodeguero/productos.js}"></script>
</th:block>

</html>