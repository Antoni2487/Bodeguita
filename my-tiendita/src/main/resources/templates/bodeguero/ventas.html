<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{bodeguero/layout :: layout(
        title=${title},
        content=~{::content},
        styles=~{::styles},
        scripts=~{::scripts},
        modals=~{::modals}
      )}">

<head>
    <th:block th:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/bodeguero/styles.css}" />
        <style>
            /* Estilos Historial */
            .table-ventas thead th { background-color: #f8fafc; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
            .badge-entrega-delivery { background-color: rgba(99, 102, 241, 0.1); color: var(--primary-color); }
            .badge-entrega-recojo { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); }
            
            /* Estilos Modal POS (Caja Registradora) */
            .pos-card { cursor: pointer; transition: 0.2s; border: 1px solid #eee; }
            .pos-card:hover { border-color: var(--primary-color); background-color: #f8faff; }
            .pos-card:active { transform: scale(0.98); }
            
            .modal-pos-layout { display: flex; height: 75vh; }
            .pos-left { flex: 1; overflow-y: auto; padding: 1rem; border-right: 1px solid #eee; }
            .pos-right { width: 350px; display: flex; flex-direction: column; background: #fdfdfd; }
            .pos-ticket-list { flex: 1; overflow-y: auto; padding: 1rem; }
            .pos-ticket-footer { padding: 1rem; background: white; border-top: 1px solid #eee; }
        </style>
    </th:block>
</head>

<th:block th:fragment="content">

    <div class="productos-header">
        <div class="header-left">
            <h2 class="page-title mb-0"><i class="bi bi-receipt-cutoff me-2"></i> Ventas</h2>
        </div>
        <div class="header-right">
            <form th:if="${bodegas != null and bodegas.size() > 1}" th:action="@{/bodeguero/ventas}" method="get" class="d-inline-block me-2">
                <select class="form-select" name="bodegaId" onchange="this.form.submit()">
                    <option th:each="b : ${bodegas}" th:value="${b.id}" th:text="${b.nombre}" th:selected="${b.id == bodegaId}"></option>
                </select>
            </form>
            
            <button class="btn btn-add text-white shadow-sm" data-bs-toggle="modal" data-bs-target="#modalPOS">
                <i class="bi bi-plus-lg me-2"></i> Registrar Venta
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden" th:if="${ventas != null and !ventas.empty}">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 table-ventas">
                <thead>
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Pago</th>
                        <th>Cliente</th>
                        <th>Estado</th>
                        <th class="text-end pe-4">Monto</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="v : ${ventas}">
                        <td class="ps-4 text-muted font-monospace">#<span th:text="${v.id}"></span></td>
                        
                        <td th:text="${#temporals.format(v.fecha, 'dd/MM HH:mm')}"></td>
                        
                        <td>
                            <span class="badge rounded-pill" 
                                th:classappend="${v.tipoEntrega.name() == 'DELIVERY'} ? 'badge-entrega-delivery' : 'badge-entrega-recojo'">
                                <i th:class="${v.tipoEntrega.name() == 'DELIVERY'} ? 'bi bi-bicycle' : 'bi bi-shop'"></i>
                                <span th:text="${v.tipoEntrega.name() == 'DELIVERY' ? 'Web/Delivery' : 'Manual'}"></span>
                            </span>
                        </td>
                        
                        <td><span class="badge bg-light text-dark border" th:text="${v.tipoMetodoPago.nombre}"></span></td>
                        
                        <td th:text="${v.clienteNombre ?: '-'}"></td>

                        <td>
                            <span class="badge" 
                                th:classappend="${v.estado == 'ANULADA'} ? 'bg-danger' : 'bg-success'"
                                th:text="${v.estado ?: 'COMPLETADA'}">
                            </span>
                        </td>

                        <td class="text-end fw-bold pe-4">S/ <span th:text="${v.monto}"></span></td>
                        
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" 
                                    th:onclick="|verDetalle(${v.id})|" 
                                    title="Ver Ticket">
                                <i class="bi bi-eye"></i>
                            </button>
                            
                            <button th:if="${v.estado != 'ANULADA'}" 
                                    class="btn btn-sm btn-outline-danger ms-1" 
                                    th:onclick="|anularVenta(${v.id})|"
                                    title="Anular Venta">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:if="${ventas == null or ventas.empty}" class="text-center py-5 bg-white rounded-4 border border-dashed">
        <i class="bi bi-receipt text-muted display-4"></i>
        <p class="mt-3 text-muted">AÃºn no hay ventas registradas.</p>
    </div>

</th:block>

<th:block th:fragment="modals">
    
    <div class="modal fade" id="modalPOS" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content overflow-hidden" style="height: 85vh;">
                <div class="modal-header bg-primary text-white py-2">
                    <h5 class="modal-title fs-6"><i class="bi bi-cart-plus me-2"></i> Nueva Venta Manual</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 modal-pos-layout">
                    
                    <div class="pos-left bg-light">
                        <input type="text" id="posSearch" class="form-control mb-3" placeholder="ðŸ” Buscar producto..." onkeyup="filtrarPos()">
                        
                        <div class="row g-2" id="posGrid">
                            <div class="col-md-4 col-sm-6 item-pos" 
                                 th:each="pb : ${productos}"
                                 th:data-nombre="${#strings.toLowerCase(pb.producto.nombre)}"
                                 th:data-prod-id="${pb.id}"
                                 th:data-prod-nombre="${pb.producto.nombre}"
                                 th:data-prod-precio="${pb.precioBodeguero}"
                                 th:data-prod-stock="${pb.stock}"
                                 onclick="agregarAlTicket(
                                     this.getAttribute('data-prod-id'), 
                                     this.getAttribute('data-prod-nombre'), 
                                     this.getAttribute('data-prod-precio'), 
                                     this.getAttribute('data-prod-stock')
                                 )">
                                
                                <div class="card pos-card h-100 shadow-sm border-0">
                                    <div class="card-body p-2 text-center">
                                        <div class="fw-bold text-truncate small" th:text="${pb.producto.nombre}">Nombre</div>
                                        <div class="text-primary fw-bold">S/ <span th:text="${pb.precioBodeguero}"></span></div>
                                        <small class="text-muted" style="font-size: 0.7rem;">Stock: <span th:text="${pb.stock}"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pos-right">
                        <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                            <strong>Ticket de Venta</strong>
                            <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" onclick="limpiarTicket()">Limpiar</button>
                        </div>
                        
                        <div class="pos-ticket-list" id="ticketList">
                            <div class="text-center text-muted mt-5 opacity-50"><small>Agrega productos</small></div>
                        </div>

                        <div class="pos-ticket-footer">
                            <div class="d-flex justify-content-between mb-2 fs-4 fw-bold text-dark">
                                <span>Total</span>
                                <span>S/ <span id="ticketTotal">0.00</span></span>
                            </div>
                            
                            <div class="mb-2">
                                <label class="small text-muted fw-bold">Pago</label>
                                <select class="form-select form-select-sm" id="posMetodoPago">
                                    <option th:each="mp : ${metodosPago}" 
                                            th:value="${mp.id}" 
                                            th:text="${mp.tipoMetodoPago.nombre}"
                                            th:selected="${mp.tipoMetodoPago.nombre == 'EFECTIVO'}"></option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <input type="text" id="posCliente" class="form-control form-control-sm" placeholder="Nombre Cliente (Opcional)">
                            </div>

                            <button class="btn btn-success w-100 fw-bold py-2" onclick="cobrar()">
                                <i class="bi bi-check-lg me-1"></i> COBRAR
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalleVenta" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm"> 
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title fs-6"><i class="bi bi-receipt"></i> Detalle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body bg-light p-3" id="ticketContent">
                    <div class="text-center mb-2 border-bottom pb-2">
                        <h5 class="fw-bold mb-0">TU BODEGUITA</h5>
                        <small class="text-muted d-block" id="detFecha">--/--/----</small>
                        <span class="badge bg-secondary mt-1" id="detId">Ticket #000</span>
                        <span class="badge bg-danger mt-1 d-none" id="detAnuladoTag">ANULADO</span>
                    </div>
    
                    <div class="mb-2 small">
                        <strong>Cliente:</strong> <span id="detCliente">-</span><br>
                        <strong>Pago:</strong> <span id="detPago">-</span>
                    </div>
    
                    <table class="table table-sm table-borderless mb-0 small">
                        <thead class="border-bottom border-dark">
                            <tr>
                                <th>Cant.</th>
                                <th>Prod.</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="detListaProductos">
                        </tbody>
                        <tfoot class="border-top border-dark fw-bold">
                            <tr>
                                <td colspan="2" class="text-end pt-2">TOTAL:</td>
                                <td class="text-end pt-2 fs-5">S/ <span id="detTotal">0.00</span></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
    
                <div class="modal-footer p-2 justify-content-center bg-white">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="imprimirTicket()">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block th:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        const BODEGA_ID = /*[[${bodegaId}]]*/ 1;
        /*]]>*/
    </script>
    
    <script th:src="@{/js/bodeguero/ventas.js}"></script>
</th:block>
    
</html>